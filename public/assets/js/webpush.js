const BASE_URL="https://push.devonics.pro";function uuidv4(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var o=16*Math.random()|0;return("x"==e?o:3&o|8).toString(16)}))}class Api{getApp(e){return fetch(`${BASE_URL}/api/apps/${e}/show`).then((e=>e.json())).then((e=>e.data.sender_id))}ipLookUp(){return fetch("https://pro.ip-api.com/json/?key=I9ShYw6mCZh58E4").then((e=>e.json()))}subscribe(e){return fetch(`${BASE_URL}/api/push-users`,{method:"POST",body:JSON.stringify(e)})}session(e){return fetch(`${BASE_URL}/api/push-users/${e}/session`)}}class Cookie{setCookie(e,o,t){let i="";if(t){const e=new Date;e.setTime(e.getTime()+24*t*60*60*1e3),i=`; expires=${e.toGMTString()}`}document.cookie=`${e}=${o+i}; path=/`}getCookie(e){let o=`${e}=`,t=document.cookie.split(";");for(let e=0;e<t.length;e++){let i=t[e];for(;" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(o))return i.substring(o.length,i.length)}return null}deleteCookie(e){this.setCookie(e,"",-1)}}var DevonicsPush={api:new Api,cookie:new Cookie,saveSessionCookie(e){console.log(e),"false"!==this.cookie.getCookie("firstVisit")&&(this.api.session(e),this.cookie.setCookie("firstVisit",!1))},isTokenSaved:e=>window.localStorage.getItem("sentFirebaseMessagingToken")===e,saveToken(e,o){this.isTokenSaved(e)?(this.saveSessionCookie(e),console.log("The token has already been sent to the server.")):(console.log("Sending a token to the server..."),this.api.ipLookUp().then((t=>{this.api.subscribe({registration_id:e,app_id:o,country:t.countryCode,platform_id:3,timezone:t.timezone,language:navigator.language.substring(0,2).toUpperCase(),uuid:uuidv4()}).then((()=>{window.localStorage.setItem("sentFirebaseMessagingToken",e||"")}))})))},subscribe(e,o){e.requestPermission().then((function(){e.getToken().then((function(e){e?DevonicsPush.saveToken(e,o):console.warn("Failed to get token.")})).catch((function(e){console.warn("An error occurred while getting the token.",e)}))})).catch((function(e){console.warn("Failed to get permission to show notifications.",e)}))},onTokenRefresh(e){e.getToken().then((function(e){console.log("Token refreshed"),this.saveToken(e)})).catch((function(e){console.error("Unable to retrieve refreshed token",e)}))},onMessage(e){console.log("Message received",e),navigator.serviceWorker.register("/firebase-messaging-sw.js"),Notification.requestPermission((function(o){"granted"===o&&navigator.serviceWorker.ready.then((function(o){e.data.data=JSON.parse(JSON.stringify(e.data)),o.showNotification(e.data.title,e.data)})).catch((function(e){console.error("ServiceWorker registration failed",e)}))}))},initialize(e){this.api.getApp(e).then((o=>{if(firebase.initializeApp({messagingSenderId:o}),"Notification"in window){const o=firebase.messaging();o.onTokenRefresh(this.onTokenRefresh),o.onMessage(this.onMessage),this.subscribe(o,e)}}))}};
