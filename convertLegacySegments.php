<?php

$segments = array (
    1 =>
        array (
            0 => '10',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Conquestador CA',
            5 => '2021-11-08 14:10:16',
            6 => '2021-11-08 14:10:16',
            7 => '{"1":["11"]}',
        ),
    3 =>
        array (
            0 => '12',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Slotozal KZ',
            5 => '2021-11-08 14:13:06',
            6 => '2021-11-08 14:13:06',
            7 => '{"1":["15"]}',
        ),
    4 =>
        array (
            0 => '14',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Ardente IT',
            5 => '2021-11-10 10:34:33',
            6 => '2021-11-10 10:34:33',
            7 => '{"1":["17"]}',
        ),
    5 =>
        array (
            0 => '15',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'PariMatch AU',
            5 => '2021-11-10 10:35:17',
            6 => '2021-11-10 10:35:17',
            7 => '{"1":["18"]}',
        ),
    6 =>
        array (
            0 => '16',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Kakadu NL',
            5 => '2021-11-10 10:36:59',
            6 => '2021-12-16 13:36:40',
            7 => '{"1":["62"]}',
        ),
    7 =>
        array (
            0 => '19',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Rocket Play NZ',
            5 => '2021-11-11 11:01:14',
            6 => '2021-11-11 11:01:14',
            7 => '{"1":["26"]}',
        ),
    8 =>
        array (
            0 => '20',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Vulkan Vegas PL',
            5 => '2021-11-12 15:00:16',
            6 => '2021-11-12 15:00:16',
            7 => '{"1":["27"]}',
        ),
    9 =>
        array (
            0 => '21',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Vulkan Vegas NO',
            5 => '2021-11-12 15:00:23',
            6 => '2021-11-12 15:00:37',
            7 => '{"1":["28"]}',
        ),
    10 =>
        array (
            0 => '22',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Vulkan Vegas CZ',
            5 => '2021-11-12 15:00:39',
            6 => '2021-11-12 15:00:56',
            7 => '{"1":["29"]}',
        ),
    11 =>
        array (
            0 => '23',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Brazino BR',
            5 => '2021-11-17 14:19:50',
            6 => '2021-11-17 14:19:50',
            7 => '{"1":["30"]}',
        ),
    12 =>
        array (
            0 => '24',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Slottica TR',
            5 => '2021-11-17 14:20:22',
            6 => '2021-11-17 14:20:22',
            7 => '{"1":["31"]}',
        ),
    13 =>
        array (
            0 => '25',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'ile de Casino FR',
            5 => '2021-11-19 12:47:39',
            6 => '2021-11-19 12:47:39',
            7 => '{"1":["32"]}',
        ),
    14 =>
        array (
            0 => '26',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Kakadu SZ',
            5 => '2021-11-26 09:17:18',
            6 => '2021-11-26 09:17:38',
            7 => '{"1":["33"]}',
        ),
    15 =>
        array (
            0 => '27',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Vulkan Vegas HU',
            5 => '2021-11-26 09:18:16',
            6 => '2021-11-26 09:18:34',
            7 => '{"1":["34"]}',
        ),
    16 =>
        array (
            0 => '29',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Kakadu SE',
            5 => '2021-12-16 13:34:07',
            6 => '2021-12-16 13:34:45',
            7 => '{"1":["54"]}',
        ),
    17 =>
        array (
            0 => '31',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Kakadu DK',
            5 => '2021-12-16 13:35:12',
            6 => '2021-12-16 13:35:34',
            7 => '{"1":["59"]}',
        ),
    18 =>
        array (
            0 => '32',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Kakadu SK',
            5 => '2021-12-16 13:35:51',
            6 => '2021-12-16 13:36:09',
            7 => '{"1":["61"]}',
        ),
    19 =>
        array (
            0 => '33',
            1 => '1',
            2 => '1',
            3 => '1',
            4 => 'Test',
            5 => '2021-12-16 14:22:48',
            6 => '2021-12-16 14:22:48',
            7 => '{"1":["63"]}',
        ),
    20 =>
        array (
            0 => '35',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Woocasino CZ',
            5 => '2021-12-29 10:15:07',
            6 => '2021-12-29 10:15:07',
            7 => '{"1":["64"]}',
        ),
    21 =>
        array (
            0 => '36',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Kakadu BR',
            5 => '2021-12-29 10:16:08',
            6 => '2021-12-29 10:16:08',
            7 => '{"1":["65"]}',
        ),
    22 =>
        array (
            0 => '37',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Vulkan Vegas PT',
            5 => '2021-12-29 10:17:06',
            6 => '2021-12-29 10:17:24',
            7 => '{"1":["66"]}',
        ),
    23 =>
        array (
            0 => '38',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Vulkan Vegas SE',
            5 => '2021-12-29 10:17:09',
            6 => '2021-12-29 10:17:46',
            7 => '{"1":["67"]}',
        ),
    24 =>
        array (
            0 => '39',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'MaChance FR',
            5 => '2021-12-29 10:20:15',
            6 => '2021-12-29 10:20:28',
            7 => '{"1":["68"]}',
        ),
    25 =>
        array (
            0 => '40',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Sol CA',
            5 => '2021-12-29 10:49:14',
            6 => '2021-12-29 10:49:14',
            7 => '{"1":["69"]}',
        ),
    26 =>
        array (
            0 => '41',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Olympia AU',
            5 => '2021-12-29 10:50:09',
            6 => '2021-12-29 10:50:09',
            7 => '{"1":["70"]}',
        ),
    27 =>
        array (
            0 => '42',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'Slotozal RU',
            5 => '2022-01-10 08:37:22',
            6 => '2022-01-10 08:37:41',
            7 => '{"1":["71"]}',
        ),
    28 =>
        array (
            0 => '43',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'ICE Casino DK',
            5 => '2022-01-17 09:32:53',
            6 => '2022-01-17 09:33:21',
            7 => '{"1":["72"]}',
        ),
    29 =>
        array (
            0 => '44',
            1 => '1',
            2 => '19',
            3 => '44',
            4 => 'ViveMonCasino FR',
            5 => '2022-01-17 09:33:27',
            6 => '2022-01-17 09:33:46',
            7 => '{"1":["73"]}',
        ),
);
$filters = array (
    0 =>
        array (
            0 => '3',
            1 => '5',
            2 => '431',
            3 => '0',
        ),
    1 =>
        array (
            0 => '4',
            1 => '4',
            2 => '1',
            3 => '0',
        ),
    2 =>
        array (
            0 => '5',
            1 => '6',
            2 => '1',
            3 => '0',
        ),
    4 =>
        array (
            0 => '7',
            1 => '5',
            2 => '470',
            3 => '0',
        ),
    5 =>
        array (
            0 => '8',
            1 => '5',
            2 => '410',
            3 => '0',
        ),
    6 =>
        array (
            0 => '9',
            1 => '5',
            2 => '335',
            3 => '0',
        ),
    7 =>
        array (
            0 => '10',
            1 => '5',
            2 => '362',
            3 => '0',
        ),
    8 =>
        array (
            0 => '11',
            1 => '5',
            2 => '292',
            3 => '0',
        ),
    9 =>
        array (
            0 => '13',
            1 => '5',
            2 => '335',
            3 => '0',
        ),
    10 =>
        array (
            0 => '14',
            1 => '5',
            2 => '267',
            3 => '0',
        ),
    11 =>
        array (
            0 => '15',
            1 => '5',
            2 => '367',
            3 => '0',
        ),
    12 =>
        array (
            0 => '16',
            1 => '5',
            2 => '362',
            3 => '0',
        ),
    13 =>
        array (
            0 => '17',
            1 => '5',
            2 => '362',
            3 => '0',
        ),
    14 =>
        array (
            0 => '18',
            1 => '5',
            2 => '266',
            3 => '0',
        ),
    15 =>
        array (
            0 => '21',
            1 => '5',
            2 => '410',
            3 => '0',
        ),
    16 =>
        array (
            0 => '22',
            1 => '5',
            2 => '470',
            3 => '0',
        ),
    17 =>
        array (
            0 => '25',
            1 => '4',
            2 => '86',
            3 => '1',
        ),
    18 =>
        array (
            0 => '26',
            1 => '5',
            2 => '413',
            3 => '0',
        ),
    19 =>
        array (
            0 => '27',
            1 => '5',
            2 => '431',
            3 => '0',
        ),
    20 =>
        array (
            0 => '28',
            1 => '5',
            2 => '420',
            3 => '0',
        ),
    21 =>
        array (
            0 => '29',
            1 => '5',
            2 => '312',
            3 => '0',
        ),
    22 =>
        array (
            0 => '30',
            1 => '5',
            2 => '284',
            3 => '0',
        ),
    23 =>
        array (
            0 => '31',
            1 => '5',
            2 => '483',
            3 => '0',
        ),
    24 =>
        array (
            0 => '32',
            1 => '5',
            2 => '328',
            3 => '0',
        ),
    25 =>
        array (
            0 => '33',
            1 => '5',
            2 => '469',
            3 => '0',
        ),
    26 =>
        array (
            0 => '34',
            1 => '5',
            2 => '353',
            3 => '0',
        ),
    27 =>
        array (
            0 => '35',
            1 => '5',
            2 => '410',
            3 => '0',
        ),
    28 =>
        array (
            0 => '36',
            1 => '5',
            2 => '470',
            3 => '0',
        ),
    29 =>
        array (
            0 => '37',
            1 => '5',
            2 => '313',
            3 => '0',
        ),
    30 =>
        array (
            0 => '38',
            1 => '5',
            2 => '410',
            3 => '0',
        ),
    31 =>
        array (
            0 => '39',
            1 => '5',
            2 => '470',
            3 => '0',
        ),
    32 =>
        array (
            0 => '40',
            1 => '5',
            2 => '313',
            3 => '0',
        ),
    37 =>
        array (
            0 => '45',
            1 => '5',
            2 => '410',
            3 => '0',
        ),
    38 =>
        array (
            0 => '46',
            1 => '5',
            2 => '457',
            3 => '0',
        ),
    39 =>
        array (
            0 => '47',
            1 => '5',
            2 => '470',
            3 => '0',
        ),
    40 =>
        array (
            0 => '48',
            1 => '5',
            2 => '313',
            3 => '0',
        ),
    41 =>
        array (
            0 => '49',
            1 => '5',
            2 => '410',
            3 => '0',
        ),
    42 =>
        array (
            0 => '50',
            1 => '5',
            2 => '457',
            3 => '0',
        ),
    43 =>
        array (
            0 => '51',
            1 => '5',
            2 => '470',
            3 => '0',
        ),
    44 =>
        array (
            0 => '52',
            1 => '5',
            2 => '313',
            3 => '0',
        ),
    45 =>
        array (
            0 => '53',
            1 => '5',
            2 => '470',
            3 => '0',
        ),
    46 =>
        array (
            0 => '54',
            1 => '5',
            2 => '470',
            3 => '0',
        ),
    47 =>
        array (
            0 => '55',
            1 => '5',
            2 => '410',
            3 => '0',
        ),
    48 =>
        array (
            0 => '56',
            1 => '5',
            2 => '457',
            3 => '0',
        ),
    49 =>
        array (
            0 => '57',
            1 => '5',
            2 => '313',
            3 => '0',
        ),
    50 =>
        array (
            0 => '58',
            1 => '5',
            2 => '313',
            3 => '0',
        ),
    51 =>
        array (
            0 => '59',
            1 => '5',
            2 => '313',
            3 => '0',
        ),
    52 =>
        array (
            0 => '60',
            1 => '5',
            2 => '410',
            3 => '0',
        ),
    53 =>
        array (
            0 => '61',
            1 => '5',
            2 => '457',
            3 => '0',
        ),
    54 =>
        array (
            0 => '62',
            1 => '5',
            2 => '410',
            3 => '0',
        ),
    55 =>
        array (
            0 => '63',
            1 => '1',
            2 => '1',
            3 => '2',
        ),
    56 =>
        array (
            0 => '64',
            1 => '5',
            2 => '312',
            3 => '0',
        ),
    57 =>
        array (
            0 => '65',
            1 => '5',
            2 => '284',
            3 => '0',
        ),
    58 =>
        array (
            0 => '66',
            1 => '5',
            2 => '432',
            3 => '0',
        ),
    59 =>
        array (
            0 => '67',
            1 => '5',
            2 => '470',
            3 => '0',
        ),
    60 =>
        array (
            0 => '68',
            1 => '5',
            2 => '328',
            3 => '0',
        ),
    61 =>
        array (
            0 => '69',
            1 => '5',
            2 => '292',
            3 => '0',
        ),
    62 =>
        array (
            0 => '70',
            1 => '5',
            2 => '266',
            3 => '0',
        ),
    63 =>
        array (
            0 => '71',
            1 => '5',
            2 => '437',
            3 => '0',
        ),
    64 =>
        array (
            0 => '72',
            1 => '5',
            2 => '313',
            3 => '0',
        ),
    65 =>
        array (
            0 => '73',
            1 => '5',
            2 => '328',
            3 => '0',
        ),
);


/**
 * Class wrapper for working with PDO
 */
class DB
{
    /**
     * Настройки подключения
     * Лучше выносить в конфиг
     * self::DB_HOST -> Config::DB_HOST
     */
    const DB_HOST = 'mysql'; // localhost
    const DB_USER = 'root';
    const DB_PASSWORD = 'root';
    const DB_NAME = 'pushDb';
    const CHARSET = 'utf8';
    const DB_PREFIX = '';

    /**
     * @var PDO
     */
    static private $db;

    /**
     * @var null
     */
    protected static $instance = null;

    /**
     * DB constructor.
     * @throws Exception
     */
    public function __construct()
    {
        if (self::$instance === null) {
            try {
                self::$db = new PDO(
                    'mysql:host=' . self::DB_HOST . ';dbname=' . self::DB_NAME,
                    self::DB_USER,
                    self::DB_PASSWORD,
                    $options = [
                        PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                        PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                    ]
                );
            } catch (PDOException $e) {
                throw new Exception ($e->getMessage());
            }
        }
        return self::$instance;
    }

    /**
     * @param $stmt
     * @return PDOStatement
     */
    public static function query($stmt)
    {
        return self::$db->query($stmt);
    }

    /**
     * @param $stmt
     * @return PDOStatement
     */
    public static function prepare($stmt)
    {
        return self::$db->prepare($stmt);
    }

    /**
     * @param $query
     * @return int
     */
    static public function exec($query)
    {
        return self::$db->exec($query);
    }

    /**
     * @return string
     */
    static public function lastInsertId()
    {
        return self::$db->lastInsertId();
    }

    /**
     * @param $query
     * @param array $args
     * @return PDOStatement
     * @throws Exception
     */
    public static function run($query, $args = [])
    {
        try {
            if (!$args) {
                return self::query($query);
            }
            $stmt = self::prepare($query);
            $stmt->execute($args);
            return $stmt;
        } catch (PDOException $e) {
            throw new Exception($e->getMessage());
        }
    }

    /**
     * @param $query
     * @param array $args
     * @return mixed
     */
    public static function getRow($query, $args = [])
    {
        return self::run($query, $args)->fetch();
    }

    /**
     * @param $query
     * @param array $args
     * @return array
     */
    public static function getRows($query, $args = [])
    {
        return self::run($query, $args)->fetchAll();
    }

    /**
     * @param $query
     * @param array $args
     * @return mixed
     */
    public static function getValue($query, $args = [])
    {
        $result = self::getRow($query, $args);
        if (!empty($result)) {
            $result = array_shift($result);
        }
        return $result;
    }

    /**
     * @param $query
     * @param array $args
     * @return array
     */
    public static function getColumn($query, $args = [])
    {
        return self::run($query, $args)->fetchAll(PDO::FETCH_COLUMN);
    }

    public static function sql($query, $args = [])
    {
        self::run($query, $args);
    }
}

$pdoConnection = new DB();

function getPredicateByFilter($filter){
    switch ($filter[3]){
        case 0:
            return 1;
        case 1:
            return 2;
        case 2:
            return 3;
    }
}

foreach ($segments as $segment){
    $relatedFilterIds = json_decode($segment[7], true);
    $pdoConnection->sql("INSERT INTO `segments`(`id`, `user_id`, `user_modified_id`, `name`, `created_at`, `updated_at`) VALUES ('{$segment[0]}','{$segment[2]}','{$segment[3]}','{$segment[4]}','{$segment[5]}','{$segment[6]}')");
    $relatedFilters = array_filter($filters, function ($filter) use($relatedFilterIds){
       return in_array($filter[0], $relatedFilterIds[1]);
    });
    foreach ($relatedFilters as $relatedFilter){
        $predicate = getPredicateByFilter($relatedFilter);
        $pdoConnection->sql("INSERT INTO `filters`(`value`, `segment_id`, `predicate_id`, `filter_type_id`) VALUES ('{$relatedFilter[2]}', '{$segment[0]}', '$predicate', '{$relatedFilter[1]}')");
    }
}
